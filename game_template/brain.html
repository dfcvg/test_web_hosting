<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ê¹Œë‹¤ë¡œìš´ ë¸Œë ˆì¸ ê²Œì„</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Jua', sans-serif;
            touch-action: none;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
            20%, 40%, 60%, 80% { transform: translateX(10px); }
        }
        .shake { animation: shake 0.5s ease-in-out; }
        .draggable { cursor: grab; user-select: none; position: absolute; }
        .dragging { cursor: grabbing; z-index: 50; }
        .level-btn:disabled { background-color: #9ca3af; cursor: not-allowed; }
        .level-btn:disabled .level-lock { display: block; }
        .level-lock { display: none; }
    </style>
</head>
<body class="bg-blue-100 flex items-center justify-center min-h-screen">

    <div id="game-container" class="w-full max-w-md mx-auto bg-white rounded-2xl shadow-2xl p-6 text-center transition-all duration-500">
        
        <div id="start-screen">
            <h1 class="text-4xl font-bold text-blue-600 mb-4">ì¢…í•© ë‘ë‡Œ ê²Œì„</h1>
            <p class="text-gray-600 mb-8">20ê°œì˜ ë¯¸ë‹ˆê²Œì„ìœ¼ë¡œ ë‹¹ì‹ ì˜ ë‡Œë¥¼ ì‹œí—˜í•˜ì„¸ìš”!</p>
            <button id="start-button" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 px-4 rounded-xl text-2xl transition-transform transform hover:scale-105">
                ë„ì „í•˜ê¸°
            </button>
        </div>
        
        <div id="level-select-screen" class="hidden">
            <h1 class="text-3xl font-bold text-blue-600 mb-6">ë ˆë²¨ ì„ íƒ</h1>
            <div id="level-grid" class="grid grid-cols-4 gap-4">
                <!-- ë ˆë²¨ ë²„íŠ¼ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤. -->
            </div>
             <button id="back-to-menu-button" class="mt-6 w-full bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">
                ì²˜ìŒìœ¼ë¡œ
            </button>
        </div>

        <div id="game-screen" class="hidden">
            <div class="flex justify-between items-center mb-4">
                 <button id="back-to-levels-button" class="text-2xl">â¬…ï¸</button>
                <span class="text-xl font-bold text-gray-500">ë ˆë²¨ <span id="level-indicator">1</span></span>
                <span></span>
            </div>
            <h2 id="question" class="text-3xl font-bold text-gray-800 mb-6 min-h-[84px] flex items-center justify-center leading-snug"></h2>
            <div id="puzzle-area" class="relative w-full h-80 bg-gray-100 rounded-xl border-4 border-gray-200 overflow-hidden flex justify-center items-center flex-wrap gap-4 p-4"></div>
        </div>
    </div>

    <div id="success-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl p-8 text-center shadow-xl transform transition-all scale-95">
            <h3 class="text-4xl font-bold text-green-500 mb-4">ì„±ê³µ!</h3>
            <p class="text-gray-700 mb-6 text-xl">ì •ë§ ëŒ€ë‹¨í•´ìš”!</p>
            <div class="flex gap-4">
                 <button id="select-level-button" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-xl text-xl">ë ˆë²¨ ì„ íƒ</button>
                <button id="next-level-button" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-xl text-xl">ë‹¤ìŒ ë ˆë²¨</button>
            </div>
        </div>
    </div>
    
    <div id="game-complete-screen" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl p-8 text-center shadow-xl">
            <h3 class="text-4xl font-bold text-yellow-500 mb-4">ëª¨ë“  ë ˆë²¨ í´ë¦¬ì–´!</h3>
            <p class="text-gray-700 mb-6 text-xl">ë‹¹ì‹ ì€ ë¸Œë ˆì¸ ë§ˆìŠ¤í„°!</p>
            <button id="restart-button" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-4 rounded-xl text-2xl">
                ì²˜ìŒë¶€í„° ë‹¤ì‹œí•˜ê¸°
            </button>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const gameContainer = document.getElementById('game-container');
        const startScreen = document.getElementById('start-screen');
        const levelSelectScreen = document.getElementById('level-select-screen');
        const gameScreen = document.getElementById('game-screen');
        const startButton = document.getElementById('start-button');
        const levelGrid = document.getElementById('level-grid');
        const backToMenuButton = document.getElementById('back-to-menu-button');
        const backToLevelsButton = document.getElementById('back-to-levels-button');
        const levelIndicator = document.getElementById('level-indicator');
        const questionEl = document.getElementById('question');
        const puzzleArea = document.getElementById('puzzle-area');
        const successModal = document.getElementById('success-modal');
        const selectLevelButton = document.getElementById('select-level-button');
        const nextLevelButton = document.getElementById('next-level-button');
        const gameCompleteScreen = document.getElementById('game-complete-screen');
        const restartButton = document.getElementById('restart-button');

        // --- Game State ---
        let currentLevelIndex = 0;
        let unlockedLevel = 1; 
        let activeDraggable = null;
        let offsetX, offsetY;
        let patienceTimer;

        const TOTAL_LEVELS = 20;

        // --- All Levels Data ---
        const levels = [
            // 1-7 (Existing)
            { question: "ì´ ì¤‘ì—ì„œ ë‹¤ë¥¸ ì´ëª¨ì§€ëŠ” ë¬´ì—‡ì¼ê¹Œìš”?", setup: setupFindDifferent(['ğŸ¼', 'ğŸ¼', 'ğŸ¼', 'ğŸ»', 'ğŸ¼', 'ğŸ¼', 'ğŸ¼', 'ğŸ¼'], 'ğŸ»') },
            { question: "í† ë¼ì—ê²Œ ë‹¹ê·¼ì„ ì£¼ì„¸ìš”.", setup: setupDragAndDrop('ğŸ°', 'ğŸ¥•') },
            { question: "ì½”ì½”ë„›ì„ ë”°ë ¤ë©´ ë‚˜ë¬´ë¥¼ í”ë“¤ì–´ì£¼ì„¸ìš”.", setup: setupShake('ğŸŒ´', 'ğŸ¥¥'), cleanup: () => window.removeEventListener('devicemotion', handleShake) },
            { question: "ê°€ì¥ <span id='trick-word' class='text-red-500 hover:text-red-700 cursor-pointer'>ë¹¨ê°„ìƒ‰</span> ê³¼ì¼ì„ í„°ì¹˜í•˜ì„¸ìš”.", setup: setupTrickWord(['ğŸ‡', 'ğŸŒ', 'ğŸˆ', 'ğŸ'], 'trick-word') },
            { question: "ê¸€ì 'íŒŒë€ìƒ‰'ì„ ëˆ„ë¥´ì„¸ìš”.", setup: setupColorTextTrick() },
            { question: "í‹°ì…”ì¸ ì— ìˆëŠ” êµ¬ë©ì€ ì´ ëª‡ ê°œì¼ê¹Œìš”?", setup: setupTshirtHoles() },
            { question: "ê³ ì–‘ì´ê°€ ë°°ê³ íŒŒìš”. ìˆ¨ê²¨ì§„ ì¥ë¥¼ ì°¾ì•„ì£¼ì„¸ìš”.", setup: setupHiddenObject('ğŸˆ', 'ğŸ', 'ğŸ“¦') },
            // 8-20 (New)
            { question: "ê°€ì¥ í° ìˆ«ìë¥¼ ë§Œë“¤ì–´ ë³´ì„¸ìš”.", setup: setupMakeLargestNumber(['7', '1', '9'], '971') },
            { question: "ì´ ë¬¸ì¥ ì–´ë”˜ê°€ì— ìˆ¨ì–´ìˆëŠ” ğŸ’ì„ ì°¾ìœ¼ì„¸ìš”.", setup: () => { puzzleArea.innerHTML = ''; document.getElementById('question').innerHTML = "ì´ ë¬¸ì¥ ì–´ë”˜ê°€ì— ìˆ¨ì–´ìˆëŠ” <span class='cursor-pointer' onclick='completeLevel()'>ğŸ’</span>ì„ ì°¾ìœ¼ì„¸ìš”."; } },
            { question: "ì–´ë‘¡ê²Œ ë§Œë“¤ì–´ ì£¼ì„¸ìš”.", setup: setupDragAway('â˜€ï¸') },
            { question: "5ì´ˆ ë™ì•ˆ ì•„ë¬´ê²ƒë„ ë§Œì§€ì§€ ë§ˆì„¸ìš”.", setup: () => { puzzleArea.innerHTML = '<div class="text-2xl">ê°€ë§Œíˆ...</div>'; patienceTimer = setTimeout(completeLevel, 5000); puzzleArea.addEventListener('click', handleWrongAnswer); }, cleanup: () => { clearTimeout(patienceTimer); puzzleArea.removeEventListener('click', handleWrongAnswer); } },
            { question: "ìƒìë¥¼ ì—´ë ¤ë©´ 'ì—´ë ¤ë¼ì°¸ê¹¨'ë¥¼ ì…ë ¥í•˜ì„¸ìš”.", setup: setupPasswordInput('ì—´ë ¤ë¼ì°¸ê¹¨', 'ğŸ“¦') },
            { question: "ê°€ì¥ ë¬´ê±°ìš´ ê²ƒì„ ê³ ë¥´ì„¸ìš”.", setup: setupFindDifferent(['ğŸˆ', 'ğŸ˜', 'â˜ï¸'], 'ğŸ˜', false) },
            { question: "ì¥ê°€ íƒˆì¶œí•˜ë„ë¡ ë„ì™€ì£¼ì„¸ìš” ğŸ", setup: setupEscape('ğŸ') },
            { question: "ì‚¬ê³¼ëŠ” ëª¨ë‘ ëª‡ ê°œì¼ê¹Œìš”?", setup: setupHiddenCount('ğŸ', 4, ['2', '3', '4']) },
            { question: "ë‹¤ìŒ ìˆœì„œì— ì˜¬ ì´ëª¨ì§€ëŠ”? ğŸ¶â†’ğŸ¦´, ğŸ°â†’ğŸ¥•, ğŸµâ†’?", setup: setupPattern(['ğŸŒ', 'ğŸ§€', 'ğŸŒ³'], 'ğŸŒ') },
            { question: "ê½ƒì„ í”¼ì›Œì£¼ì„¸ìš”.", setup: setupCombine('ğŸŒ§ï¸', 'ğŸŒ±', 'ğŸŒ¸') },
            { question: "ê°€ì¥ í° <span id='trick-circle' class='cursor-pointer'>ì›</span>ì„ í„°ì¹˜í•˜ì„¸ìš”.", setup: setupTrickWord(['âš«', 'ğŸ”µ', 'ğŸ”´'], 'trick-circle') },
            { question: "ì´ˆë¡ ë²„íŠ¼ì„ ëˆ„ë¥´ê¸° ì „ì—, íŒŒë€ ë²„íŠ¼ì„ ë¨¼ì € ëˆ„ë¥´ì„¸ìš”.", setup: setupSequenceButtons() },
            { question: "ê²Œì„ì„ ëë‚´ë ¤ë©´ ì´ ë ˆë²¨ì˜ ìˆ«ìë¥¼ ëˆ„ë¥´ì„¸ìš”.", setup: () => { puzzleArea.innerHTML = '<div class="text-4xl">ğŸ¤”</div>'; levelIndicator.parentElement.classList.add('cursor-pointer'); levelIndicator.parentElement.onclick = () => { completeLevel(); }; }, cleanup: () => { levelIndicator.parentElement.classList.remove('cursor-pointer'); levelIndicator.parentElement.onclick = null; } }
        ];
        
        // --- Screen Management ---
        function showScreen(screen) {
            [startScreen, levelSelectScreen, gameScreen, gameCompleteScreen].forEach(s => s.classList.add('hidden'));
            screen.classList.remove('hidden');
        }

        function showLevelSelect() {
            levelGrid.innerHTML = '';
            for (let i = 1; i <= TOTAL_LEVELS; i++) {
                const btn = document.createElement('button');
                btn.className = 'level-btn h-16 bg-blue-500 hover:bg-blue-600 text-white font-bold rounded-lg flex items-center justify-center text-2xl relative transition-all';
                if (i <= unlockedLevel) {
                    btn.textContent = i;
                    btn.onclick = () => loadLevel(i - 1);
                } else {
                    btn.innerHTML = `<span>${i}</span><span class="level-lock absolute text-4xl">ğŸ”’</span>`;
                    btn.disabled = true;
                }
                levelGrid.appendChild(btn);
            }
            showScreen(levelSelectScreen);
        }

        // --- Game Flow ---
        function loadLevel(levelIndex) {
            if (levels[currentLevelIndex]?.cleanup) levels[currentLevelIndex].cleanup();
            currentLevelIndex = levelIndex;
            if (levelIndex >= levels.length) {
                showGameComplete();
                return;
            }
            levelIndicator.textContent = levelIndex + 1;
            questionEl.innerHTML = levels[levelIndex].question;
            puzzleArea.innerHTML = ''; 
            levels[levelIndex].setup();
            showScreen(gameScreen);
        }

        function completeLevel() {
            unlockedLevel = Math.max(unlockedLevel, currentLevelIndex + 2);
            if (currentLevelIndex >= levels.length -1) {
                nextLevelButton.classList.add('hidden');
            } else {
                nextLevelButton.classList.remove('hidden');
            }
            successModal.classList.remove('hidden');
            setTimeout(() => successModal.querySelector('div').classList.remove('scale-95'), 10);
        }

        function nextLevel() {
            successModal.classList.add('hidden');
            successModal.querySelector('div').classList.add('scale-95');
            loadLevel(currentLevelIndex + 1);
        }

        function handleWrongAnswer() {
            if (patienceTimer) clearTimeout(patienceTimer);
            gameContainer.classList.add('shake');
            setTimeout(() => gameContainer.classList.remove('shake'), 500);
        }

        // --- Setup Functions for Levels ---
        function setupFindDifferent(items, answer, shuffle = true) {
            return () => {
                if (shuffle) items.sort(() => Math.random() - 0.5);
                items.forEach(emoji => {
                    const div = document.createElement('div');
                    div.textContent = emoji;
                    div.className = "text-5xl cursor-pointer transition-transform hover:scale-125";
                    div.onclick = () => (emoji === answer) ? completeLevel() : handleWrongAnswer();
                    puzzleArea.appendChild(div);
                });
            };
        }

        function setupDragAndDrop(targetEmoji, draggableEmoji) {
            return () => {
                const target = document.createElement('div');
                target.textContent = targetEmoji;
                target.className = "text-8xl absolute bottom-8 right-8";
                const draggable = document.createElement('div');
                draggable.textContent = draggableEmoji;
                draggable.className = "draggable text-7xl top-8 left-8";
                puzzleArea.append(target, draggable);
                makeDraggable(draggable, () => {
                    const targetRect = target.getBoundingClientRect();
                    const draggableRect = draggable.getBoundingClientRect();
                    const isOverlapping = !(draggableRect.right < targetRect.left || draggableRect.left > targetRect.right || draggableRect.bottom < targetRect.top || draggableRect.top > targetRect.bottom);
                    if (isOverlapping) completeLevel();
                });
            };
        }
        
        function setupShake(treeEmoji, fruitEmoji) {
            return () => {
                const tree = document.createElement('div');
                tree.textContent = treeEmoji;
                tree.className = 'text-9xl absolute bottom-0 right-1/2 translate-x-1/2';
                const fruit = document.createElement('div');
                fruit.id = 'fruit';
                fruit.textContent = fruitEmoji;
                fruit.className = 'text-4xl absolute -top-4 -right-4 transition-all duration-1000';
                tree.appendChild(fruit);
                puzzleArea.appendChild(tree);
                window.addEventListener('devicemotion', handleShake);
            }
        }
        
        function handleShake(event) {
            if (event.acceleration.x > 15 || event.acceleration.y > 15) {
                const fruit = document.getElementById('fruit');
                if (fruit) {
                    fruit.style.transform = 'translateY(150px)';
                    setTimeout(() => {
                        completeLevel();
                        window.removeEventListener('devicemotion', handleShake);
                    }, 1000);
                }
            }
        }

        function setupTrickWord(items, trickWordId) {
            return () => {
                items.forEach(emoji => {
                    const div = document.createElement('div');
                    div.textContent = emoji;
                    div.className = "text-6xl cursor-pointer transition-transform hover:scale-125";
                    div.onclick = handleWrongAnswer;
                    puzzleArea.appendChild(div);
                });
                document.getElementById(trickWordId).onclick = completeLevel;
            };
        }
        
        function setupColorTextTrick() {
            return () => {
                const colors = [{ text: 'ë¹¨ê°„ìƒ‰', color: 'text-blue-500' }, { text: 'ë…¸ë€ìƒ‰', color: 'text-green-500' }, { text: 'íŒŒë€ìƒ‰', color: 'text-red-500' }, { text: 'ì´ˆë¡ìƒ‰', color: 'text-yellow-500' }];
                colors.sort(() => Math.random() - 0.5);
                colors.forEach(item => {
                    const button = document.createElement('button');
                    button.textContent = item.text;
                    button.className = `w-2/5 text-2xl font-bold p-4 rounded-lg ${item.color} bg-gray-200 hover:bg-gray-300`;
                    button.onclick = () => (item.text === 'íŒŒë€ìƒ‰') ? completeLevel() : handleWrongAnswer();
                    puzzleArea.appendChild(button);
                });
            }
        }
        
        function setupTshirtHoles() {
            return () => {
                puzzleArea.innerHTML = `<div class="text-9xl relative">ğŸ‘•<div class="absolute top-1/2 left-1/3 w-4 h-4 bg-gray-100 rounded-full"></div><div class="absolute top-2/3 left-2/3 w-4 h-4 bg-gray-100 rounded-full"></div></div><div id="answer-options" class="w-full flex justify-center gap-4 absolute bottom-4"></div>`;
                ['5ê°œ', '6ê°œ', '8ê°œ'].forEach(option => {
                    const button = document.createElement('button');
                    button.textContent = option;
                    button.className = 'text-xl font-bold p-3 rounded-lg bg-white hover:bg-gray-200 w-20';
                    button.onclick = () => (option === '8ê°œ') ? completeLevel() : handleWrongAnswer();
                    document.getElementById('answer-options').appendChild(button);
                });
            }
        }

        function setupHiddenObject(mainEmoji, hiddenEmoji, coverEmoji) {
            return () => {
                const main = document.createElement('div');
                main.textContent = mainEmoji;
                main.className = "text-8xl absolute bottom-8 right-8";
                const hidden = document.createElement('div');
                hidden.textContent = hiddenEmoji;
                hidden.className = "text-5xl absolute top-10 left-10 z-0 cursor-pointer";
                hidden.onclick = completeLevel;
                const cover = document.createElement('div');
                cover.textContent = coverEmoji;
                cover.className = "draggable text-9xl top-8 left-8 z-10";
                puzzleArea.append(main, hidden, cover);
                makeDraggable(cover);
            }
        }

        function setupMakeLargestNumber(digits, answer) {
            return () => {
                const dropZone = document.createElement('div');
                dropZone.id = 'drop-zone';
                dropZone.className = 'w-4/5 h-24 bg-gray-200 rounded-lg flex items-center justify-center text-4xl text-gray-400';
                dropZone.textContent = 'ì—¬ê¸°ì— ìˆ«ìë¥¼ ë†“ìœ¼ì„¸ìš”';
                puzzleArea.appendChild(dropZone);

                const digitContainer = document.createElement('div');
                digitContainer.className = 'w-full flex justify-center gap-4 absolute bottom-4';
                digits.forEach(digit => {
                    const div = document.createElement('div');
                    div.textContent = digit;
                    div.className = 'draggable text-6xl w-16 h-16 flex items-center justify-center';
                    makeDraggable(div, () => {
                        let currentOrder = Array.from(puzzleArea.querySelectorAll('.draggable')).sort((a, b) => a.getBoundingClientRect().left - b.getBoundingClientRect().left).map(d => d.textContent).join('');
                        dropZone.textContent = currentOrder;
                        if (currentOrder === answer) completeLevel();
                    });
                    digitContainer.appendChild(div);
                });
                puzzleArea.appendChild(digitContainer);
            }
        }
        
        function setupDragAway(emoji) {
            return () => {
                 const item = document.createElement('div');
                 item.textContent = emoji;
                 item.className = 'draggable text-9xl';
                 puzzleArea.appendChild(item);
                 makeDraggable(item, () => {
                    const itemRect = item.getBoundingClientRect();
                    const areaRect = puzzleArea.getBoundingClientRect();
                    if(itemRect.right < areaRect.left || itemRect.left > areaRect.right || itemRect.bottom < areaRect.top || itemRect.top > areaRect.bottom) {
                        completeLevel();
                    }
                 });
            }
        }

        function setupPasswordInput(password, emoji) {
            return () => {
                puzzleArea.innerHTML = `
                    <div class="text-8xl">${emoji}</div>
                    <input id="password-input" type="text" class="absolute bottom-4 w-4/5 p-2 text-center rounded-lg border-2" placeholder="ì •ë‹µ ì…ë ¥">
                `;
                const input = document.getElementById('password-input');
                input.oninput = () => {
                    if (input.value === password) completeLevel();
                };
            }
        }

        function setupEscape(emoji) {
             return () => {
                 const item = document.createElement('div');
                 item.textContent = emoji;
                 item.className = 'draggable text-6xl';
                 puzzleArea.appendChild(item);
                 puzzleArea.style.overflow = 'visible';
                 makeDraggable(item, () => {
                    const itemRect = item.getBoundingClientRect();
                    const areaRect = puzzleArea.getBoundingClientRect();
                    if(itemRect.right < areaRect.left || itemRect.left > areaRect.right || itemRect.bottom < areaRect.top || itemRect.top > areaRect.bottom) {
                        completeLevel();
                    }
                 });
            }
        }
        
        function setupHiddenCount(emoji, answer, options) {
            return () => {
                puzzleArea.innerHTML = `
                    <div class="text-7xl absolute top-1/4 left-1/4">${emoji}</div>
                    <div class="text-7xl absolute top-1/2 left-1/2">${emoji}</div>
                    <div class="draggable text-7xl absolute top-1/3 left-2/3 z-10">${emoji}</div>
                    <div class="text-7xl absolute top-1/3 left-2/3 z-0">${emoji}</div>
                    <div id="answer-options" class="w-full flex justify-center gap-4 absolute bottom-4"></div>
                `;
                makeDraggable(puzzleArea.querySelector('.draggable'));
                options.forEach(option => {
                    const button = document.createElement('button');
                    button.textContent = option;
                    button.className = 'text-xl font-bold p-3 rounded-lg bg-white hover:bg-gray-200 w-20';
                    button.onclick = () => (parseInt(option) === answer) ? completeLevel() : handleWrongAnswer();
                    document.getElementById('answer-options').appendChild(button);
                });
            }
        }

        function setupPattern(options, answer) {
            return () => {
                options.forEach(option => {
                    const div = document.createElement('div');
                    div.textContent = option;
                    div.className = "text-6xl cursor-pointer transition-transform hover:scale-125";
                    div.onclick = () => (option === answer) ? completeLevel() : handleWrongAnswer();
                    puzzleArea.appendChild(div);
                });
            }
        }

        function setupCombine(item1Emoji, item2Emoji, resultEmoji) {
            return () => {
                const item1 = document.createElement('div');
                item1.textContent = item1Emoji;
                item1.className = 'draggable text-8xl top-8 left-8';
                const item2 = document.createElement('div');
                item2.id = 'target';
                item2.textContent = item2Emoji;
                item2.className = 'text-8xl bottom-8 right-8';
                puzzleArea.append(item1, item2);

                makeDraggable(item1, () => {
                    const rect1 = item1.getBoundingClientRect();
                    const rect2 = item2.getBoundingClientRect();
                    if(!(rect1.right < rect2.left || rect1.left > rect2.right || rect1.bottom < rect2.top || rect1.top > rect2.bottom)) {
                        item2.textContent = resultEmoji;
                        item2.classList.add('transition-transform', 'duration-500', 'scale-150');
                        item1.remove();
                        setTimeout(completeLevel, 500);
                    }
                });
            }
        }

        function setupSequenceButtons() {
            let bluePressed = false;
            const blueBtn = document.createElement('button');
            blueBtn.className = 'w-2/5 h-24 bg-blue-500 text-white font-bold rounded-lg text-2xl';
            blueBtn.textContent = 'íŒŒë€ ë²„íŠ¼';
            blueBtn.onclick = () => { bluePressed = true; blueBtn.style.opacity = '0.5'; };

            const greenBtn = document.createElement('button');
            greenBtn.className = 'w-2/5 h-24 bg-green-500 text-white font-bold rounded-lg text-2xl';
            greenBtn.textContent = 'ì´ˆë¡ ë²„íŠ¼';
            greenBtn.onclick = () => {
                if (bluePressed) completeLevel();
                else handleWrongAnswer();
            };
            puzzleArea.append(blueBtn, greenBtn);
        }


        // --- Draggable Logic ---
        function makeDraggable(element, onDropCallback) {
            element.addEventListener('mousedown', startDrag);
            element.addEventListener('touchstart', startDrag, { passive: false });
            function startDrag(e) {
                e.preventDefault();
                activeDraggable = element;
                activeDraggable.classList.add('dragging');
                const rect = activeDraggable.getBoundingClientRect();
                const parentRect = puzzleArea.getBoundingClientRect();
                if (e.type === 'touchstart') {
                    offsetX = e.touches[0].clientX - rect.left + parentRect.left;
                    offsetY = e.touches[0].clientY - rect.top + parentRect.top;
                } else {
                    offsetX = e.clientX - rect.left + parentRect.left;
                    offsetY = e.clientY - rect.top + parentRect.top;
                }
                document.addEventListener('mousemove', drag);
                document.addEventListener('touchmove', drag, { passive: false });
                document.addEventListener('mouseup', endDrag);
                document.addEventListener('touchend', endDrag);
            }
            function drag(e) {
                if (!activeDraggable) return;
                e.preventDefault();
                let x = e.type.startsWith('touch') ? e.touches[0].clientX : e.clientX;
                let y = e.type.startsWith('touch') ? e.touches[0].clientY : e.clientY;
                activeDraggable.style.left = `${x - offsetX}px`;
                activeDraggable.style.top = `${y - offsetY}px`;
            }
            function endDrag() {
                if (!activeDraggable) return;
                activeDraggable.classList.remove('dragging');
                document.removeEventListener('mousemove', drag);
                document.removeEventListener('touchmove', drag);
                document.removeEventListener('mouseup', endDrag);
                document.removeEventListener('touchend', endDrag);
                activeDraggable = null;
                if (onDropCallback) onDropCallback();
            }
        }
        
        // --- Initial Event Listeners ---
        startButton.addEventListener('click', () => {
            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                DeviceMotionEvent.requestPermission();
            }
            showLevelSelect();
        });

        nextLevelButton.addEventListener('click', nextLevel);
        selectLevelButton.addEventListener('click', () => {
            successModal.classList.add('hidden');
            showLevelSelect();
        });
        
        backToLevelsButton.addEventListener('click', showLevelSelect);
        backToMenuButton.addEventListener('click', () => showScreen(startScreen));
        
        restartButton.addEventListener('click', () => {
            unlockedLevel = 1;
            gameCompleteScreen.classList.add('hidden');
            showScreen(startScreen);
        });
    </script>
</body>
</html>

