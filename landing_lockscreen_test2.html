<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>연결 중</title>
    <style>
        body { font-family: -apple-system, sans-serif; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; background: #fff; }
        .msg-box { text-align: center; padding: 20px; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #4285F4; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #manual-btn { display: none; margin-top: 20px; padding: 12px 24px; background: #333; color: white; text-decoration: none; border-radius: 8px; font-weight: bold; }
    </style>
</head>
<body>

    <div class="msg-box">
        <div class="loader" id="loader"></div>
        <h2 id="status-title">앱으로 연결하고 있습니다</h2>
        <p id="status-desc">잠금을 해제하면 자동으로 연결됩니다.</p>
        <a href="#" id="manual-btn">앱으로 직접 이동하기</a>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        let target = urlParams.get('target');
        const browserType = urlParams.get('browser'); // 'samsung', 'naver', 'google', 'chrome'
        
        if (target) target = decodeURIComponent(target);

        const LAUNCHED_KEY = 'did_launch_final';

        // 1. 패키지명 매핑 (구글 앱 추가)
        const packages = {
            'samsung': 'com.sec.android.app.sbrowser',
            'naver': 'com.nhn.android.search',
            'google': 'com.google.android.googlequicksearchbox', // 구글 앱
            'chrome': 'com.android.chrome'
        };

        function launchApp() {
            // 이미 성공적으로 나갔다면 중복 실행 방지
            if (sessionStorage.getItem(LAUNCHED_KEY) === 'true') {
                showSuccessUI();
                return;
            }

            if (!target) return;
            sessionStorage.setItem(LAUNCHED_KEY, 'true');

            if (browserType && packages[browserType]) {
                let cleanUrl = target;
                let scheme = "https";
                

                // 인텐트 조립 (미설치 시 원래 타겟으로 복귀하는 Fallback 포함)
                const intentUrl = `intent://${cleanUrl}#Intent;scheme=${scheme};package=${packages[browserType]};S.browser_fallback_url=${encodeURIComponent(target)};end`;
                
                window.location.href = intentUrl;
            } else {
                window.location.href = target;
            }

            setTimeout(showSuccessUI, 3000);
        }

        function showSuccessUI() {
            document.getElementById('loader').style.display = 'none';
            document.getElementById('status-title').innerText = "연결을 시도했습니다";
            const btn = document.getElementById('manual-btn');
            btn.style.display = 'inline-block';
            btn.href = target;

            // 브라우저별 테마 색상 적용
            const colors = { 'google': '#4285F4', 'naver': '#2db400', 'samsung': '#0c4da2', 'chrome': '#333' };
            if (colors[browserType]) btn.style.background = colors[browserType];
        }

        // 초기 실행 (잠금 안된 상태)
        window.onload = () => {
            if (document.visibilityState === 'visible' && !sessionStorage.getItem(LAUNCHED_KEY)) {
                window.location.href = target;
            }
        };

        // 패턴 해제 감지
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                if (sessionStorage.getItem(LAUNCHED_KEY) === 'true') {
                    showSuccessUI();
                } else {
                    launchApp();
                }
            }
        });
    </script>
</body>
</html>
