<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>연결 중...</title>
    <style>
        body { font-family: -apple-system, sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; background: #f9f9fb; }
        .loader { border: 4px solid #e2e2e2; border-top: 4px solid #3498db; border-radius: 50%; width: 36px; height: 36px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .message { margin-top: 24px; text-align: center; color: #444; padding: 0 20px; }
        .btn { display: none; margin-top: 24px; padding: 14px 28px; background: #3498db; color: white; text-decoration: none; border-radius: 10px; font-weight: 600; }
    </style>
</head>
<body>

    <div class="loader" id="loader"></div>
    <div class="message">
        <h2 id="status-title">앱으로 연결 중입니다</h2>
        <p id="status-desc">잠금화면을 해제하면 자동으로 연결됩니다.</p>
    </div>
    <a href="#" id="manual-btn" class="btn">앱으로 직접 이동하기</a>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        let targetLink = urlParams.get('target');
        if (targetLink) { try { targetLink = decodeURIComponent(targetLink); } catch (e) {} }

        const statusTitle = document.getElementById('status-title');
        const statusDesc = document.getElementById('status-desc');
        const manualBtn = document.getElementById('manual-btn');
        const loader = document.getElementById('loader');

        let lastHideTime = 0;

        // 핵심: 앱 실행 시도 상태 관리
        const STATE_KEY = 'did_attempt_app_launch';

        function executeDeepLink(link) {
            // 이미 성공적으로 실행했다고 판단되면 중단
            if (sessionStorage.getItem(STATE_KEY) === 'success') return;

            lastHideTime = Date.now();
            window.location.href = link;
            
            // 4초 후에도 브라우저에 남아있다면 수동 버튼 노출
            setTimeout(() => {
                if (sessionStorage.getItem(STATE_KEY) !== 'success') {
                    manualBtn.style.display = "inline-block";
                    loader.style.display = "none";
                }
            }, 4000);
        }

        // 페이지 가시성 변화 감지 (패턴 해제 또는 앱 복귀)
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden') {
                lastHideTime = Date.now();
            } else if (document.visibilityState === 'visible') {
                const timeGap = Date.now() - lastHideTime;

                // 1. 앱 실행 성공 추론: 브라우저가 2초 이상 가려졌다가 돌아왔다면?
                // (앱이 켜졌거나 패턴을 푸는 데 시간이 걸렸다고 판단)
                if (lastHideTime !== 0 && timeGap > 2000) {
                    sessionStorage.setItem(STATE_KEY, 'success');
                    statusTitle.innerText = "앱 연결을 시도했습니다";
                    statusDesc.innerText = "이동이 되지 않았다면 아래 버튼을 눌러주세요.";
                    loader.style.display = "none";
                    manualBtn.style.display = "inline-block";
                } 
                // 2. 단순 복귀 혹은 첫 시도인 경우
                else if (sessionStorage.getItem(STATE_KEY) !== 'success') {
                    executeDeepLink(targetLink);
                }
            }
        });

        // 초기 실행
        window.onload = () => {
            if (!targetLink) {
                statusTitle.innerText = "주소가 올바르지 않습니다.";
                loader.style.display = "none";
                return;
            }
            manualBtn.href = targetLink;

            // 잠금이 안 걸린 상태라면 즉시 실행
            if (document.visibilityState === 'visible') {
                executeDeepLink(targetLink);
            }
        };
    </script>
</body>
</html>
