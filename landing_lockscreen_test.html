<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>연결 중...</title>
    <style>
        body { font-family: -apple-system, sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; background: #f9f9fb; }
        .loader { border: 4px solid #e2e2e2; border-top: 4px solid #3498db; border-radius: 50%; width: 36px; height: 36px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .message { margin-top: 24px; text-align: center; color: #444; padding: 0 20px; }
        .btn { display: none; margin-top: 24px; padding: 14px 28px; background: #3498db; color: white; text-decoration: none; border-radius: 10px; font-weight: 600; }
    </style>
</head>
<body>

    <div class="loader" id="loader"></div>
    <div class="message">
        <h2 id="status-title">앱으로 연결 중입니다</h2>
        <p id="status-desc">잠금을 해제하면 자동으로 이동합니다.</p>
    </div>
    <a href="#" id="manual-btn" class="btn">앱으로 직접 이동하기</a>

    <script>
        // 1. URL 파라미터 및 딥링크 준비
        const urlParams = new URLSearchParams(window.location.search);
        let targetLink = urlParams.get('target');
        if (targetLink) { try { targetLink = decodeURIComponent(targetLink); } catch (e) {} }
     alert('a')
        const statusTitle = document.getElementById('status-title');
        const manualBtn = document.getElementById('manual-btn');
        const loader = document.getElementById('loader');

        // 상태 관리 플래그 (세션 내 중복 실행 방지)
        const LAUNCHED_KEY = 'app_launch_done';

        function executeDeepLink() {
            if (!targetLink) return;
            
            // 이미 이 탭에서 실행을 완료했다면 중단 (중복 팝업 방지)
            if (sessionStorage.getItem(LAUNCHED_KEY)) {
                showManualUI();
                return;
            }

            // 앱 이동 시도
            window.location.href = targetLink;
            
            // 실행 직후 바로 "실행됨" 기록
            sessionStorage.setItem(LAUNCHED_KEY, 'true');

            // 3초 후에도 브라우저에 머물러 있다면 버튼 보여주기
            setTimeout(showManualUI, 3000);
        }

        function showManualUI() {
            loader.style.display = "none";
            manualBtn.style.display = "inline-block";
            statusTitle.innerText = "연결을 완료했습니다";
        }

        // 2. 가시성 변화 감지 (패턴 해제 감지용)
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                // 사용자가 패턴을 풀고 브라우저로 돌아왔을 때, 
                // 만약 아직 한 번도 실행 안 했다면 실행!
                if (!sessionStorage.getItem(LAUNCHED_KEY)) {
                    executeDeepLink();
                } else {
                    // 이미 시도했었다면 수동 버튼으로 전환
                    showManualUI();
                }
            }
        });

        // 3. 페이지 로드 즉시 실행
        window.onload = () => {
            if (!targetLink) {
                statusTitle.innerText = "대상 주소가 없습니다.";
                loader.style.display = "none";
                return;
            }
            manualBtn.href = targetLink;

            // 로드 시점에 화면이 보이면 즉시 딥링크 실행
            if (document.visibilityState === 'visible') {
                executeDeepLink();
            }
        };
    </script>
</body>
</html>
