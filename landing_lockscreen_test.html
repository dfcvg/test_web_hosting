<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>연결 중...</title>
    <style>
        body { font-family: -apple-system, sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; background: #f4f7fa; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .message { margin-top: 20px; text-align: center; color: #333; }
        .btn { display: none; margin-top: 20px; padding: 12px 24px; background: #3498db; color: white; text-decoration: none; border-radius: 8px; font-weight: bold; }
    </style>
</head>
<body>

    <div class="loader" id="loader"></div>
    <div class="message">
        <h2 id="status-title">앱으로 연결 중입니다</h2>
        <p id="status-desc">잠금을 해제하면 자동으로 연결됩니다.</p>
    </div>
    <a href="#" id="manual-btn" class="btn">앱으로 직접 이동하기</a>

    <script>
        // 1. 설정 및 파라미터 추출
        const urlParams = new URLSearchParams(window.location.search);
        let targetLink = urlParams.get('target');
        const isReloaded = urlParams.get('reloaded'); // 재호출 여부 플래그
        
        if (targetLink) {
            try { targetLink = decodeURIComponent(targetLink); } catch(e) {}
        }

        const statusTitle = document.getElementById('status-title');
        const manualBtn = document.getElementById('manual-btn');

        // 2. 딥링크 실행 함수
        function launchApp(link) {
            if (!link) return;
            window.location.href = link;
            
            // 앱 이동 실패 시 3.5초 후 수동 버튼 노출
            setTimeout(() => {
                document.getElementById('loader').style.display = "none";
                manualBtn.style.display = "inline-block";
                manualBtn.href = link;
            }, 3500);
        }

        // 3. 페이지 로드 시점 로직
        window.onload = () => {
            if (!targetLink) {
                statusTitle.innerText = "대상 주소가 없습니다.";
                return;
            }

            // 만약 이미 인텐트로 재호출된 상태라면 바로 딥링크 실행
            if (isReloaded === 'true' || document.visibilityState === 'visible') {
                launchApp(targetLink);
            }
        };

        // 4. [핵심] 패턴 해제(Visibility Change) 감지 및 크롬 재호출
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible' && isReloaded !== 'true') {
                
                // 패턴을 풀고 돌아온 시점에 크롬 브라우저를 '인텐트'로 새로 깨움
                // 이렇게 하면 브라우저의 User Gesture 권한이 갱신될 확률이 높습니다.
                const currentUrl = new URL(window.location.href);
                currentUrl.searchParams.set('reloaded', 'true'); // 무한루프 방지 플래그 추가
                
                const chromeIntent = `intent://${currentUrl.host}${currentUrl.pathname}${currentUrl.search}#Intent;scheme=https;package=com.android.chrome;end`;
                
                statusTitle.innerText = "연결을 재시도합니다...";
                
                // 현재 페이지를 크롬 인텐트로 다시 로드
                window.location.href = chromeIntent;
            }
        });
    </script>
</body>
</html>
